name: Build A1 Evo Acoustica Tool

on:
  workflow_dispatch: # Allows manual triggering
  push:
    branches: [ main, master ] # Runs on pushes to these branches
  pull_request:
    branches: [ main, master ] # Runs on PRs targeting these branches

jobs:
  build:
    strategy:
      fail-fast: false # Allows other jobs to continue if one fails
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ] # Run on all 3 OS
    runs-on: ${{ matrix.os }}
    name: Build on ${{ matrix.os }} (Node 18)

    steps:
      - name: üßæ Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Set up Node.js v18
        uses: actions/setup-node@v4
        with:
          node-version: '18' # Use Node 18 LTS consistently
          cache: 'npm'

      - name: üì¶ Install Dependencies
        run: npm ci # Clean install using package-lock.json

      - name: üõ†Ô∏è Build Executables with pkg
        # This executes the 'build' script from package.json which should
        # target node18 for win-x64, linux-x64, macos-x64, macos-arm64
        run: npm run build

      # Add step to list files AFTER build to help diagnose missing executables
      - name: üìú List Files After Build
        shell: bash
        run: ls -l

      - name: üì¶ Prepare Artifacts
        shell: bash
        run: |
          echo "Creating staging directory..."
          mkdir staging
          OUTPUT_BASE="a1-evo-acoustica" # Should match --output in package.json
          TARGET_DIR="./staging"
          EXE_FOUND=false # Flag

          echo "Moving executables for ${{ matrix.os }}..."

          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            echo "Looking for Windows executable..."
            if [ -f ./${OUTPUT_BASE}-win.exe ]; then mv ./${OUTPUT_BASE}-win.exe ${TARGET_DIR}/; EXE_FOUND=true; echo "Moved ${OUTPUT_BASE}-win.exe";
            elif [ -f ./${OUTPUT_BASE}-win-x64.exe ]; then mv ./${OUTPUT_BASE}-win-x64.exe ${TARGET_DIR}/${OUTPUT_BASE}-win.exe; EXE_FOUND=true; echo "Moved ${OUTPUT_BASE}-win-x64.exe";
            elif [ -f ./${OUTPUT_BASE}.exe ]; then mv ./${OUTPUT_BASE}.exe ${TARGET_DIR}/${OUTPUT_BASE}-win.exe; EXE_FOUND=true; echo "Moved ${OUTPUT_BASE}.exe";
            fi

          elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
             echo "Looking for Linux executable..."
             if [ -f ./$OUTPUT_BASE ]; then mv ./$OUTPUT_BASE ${TARGET_DIR}/${OUTPUT_BASE}-linux-x64; EXE_FOUND=true; echo "Moved $OUTPUT_BASE";
             elif [ -f ./${OUTPUT_BASE}-linux ]; then mv ./${OUTPUT_BASE}-linux ${TARGET_DIR}/${OUTPUT_BASE}-linux-x64; EXE_FOUND=true; echo "Moved ${OUTPUT_BASE}-linux";
             elif [ -f ./${OUTPUT_BASE}-linux-x64 ]; then mv ./${OUTPUT_BASE}-linux-x64 ${TARGET_DIR}/; EXE_FOUND=true; echo "Moved ${OUTPUT_BASE}-linux-x64";
             fi

          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
             echo "Looking for macOS executables..."
             if [ -f ./${OUTPUT_BASE}-macos-x64 ]; then mv ./${OUTPUT_BASE}-macos-x64 ${TARGET_DIR}/; EXE_FOUND=true; echo "Moved ${OUTPUT_BASE}-macos-x64";
             fi
             if [ -f ./${OUTPUT_BASE}-macos-arm64 ]; then mv ./${OUTPUT_BASE}-macos-arm64 ${TARGET_DIR}/; EXE_FOUND=true; echo "Moved ${OUTPUT_BASE}-macos-arm64";
             fi
             if [ "$EXE_FOUND" = false ] && [ -f ./${OUTPUT_BASE}-macos ]; then mv ./${OUTPUT_BASE}-macos ${TARGET_DIR}/${OUTPUT_BASE}-macos-x64; EXE_FOUND=true; echo "Moved ${OUTPUT_BASE}-macos (fallback)";
             fi
          else
            echo "::error::Unknown OS for artifact moving: ${{ matrix.os }}"
            exit 1
          fi

          # Final Check - Fail job if executable wasn't found and moved
          if [ "$EXE_FOUND" = false ]; then
            echo "::error::No executable found to move for ${{ matrix.os }} with base name ${OUTPUT_BASE}"
            echo "Files present after build:"
            ls -l ./
            exit 1
          else
             echo "Staging directory contents:"
             ls -l ${TARGET_DIR}
          fi

      - name: üì§ Upload Artifact (${{ matrix.os }})
        uses: actions/upload-artifact@v4
        with:
          name: a1-evo-acoustica-${{ matrix.os }}
          path: staging/ # Upload contents of staging directory
